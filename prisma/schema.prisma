generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                        String              @id @default(cuid())
  email                     String              @unique
  name                      String?
  password                  String?
  orgId                     String?
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  emailVerified             DateTime?
  emailVerifyExpires        DateTime?
  emailVerifyToken          String?
  image                     String?
  passwordResetExpires      DateTime?
  passwordResetToken        String?
  onboardingComplete        Boolean             @default(false)
  accountType               String?
  accounts                  Account[]
  auditLogs                 AuditLog[]
  createdJudgeInvites       JudgeInvite[]       @relation("JudgeInviteCreatedBy")
  usedJudgeInvites          JudgeInvite[]       @relation("JudgeInviteUsedBy")
  ownedOrgs                 Organization[]      @relation("OrgOwner")
  createdRegistrationTokens RegistrationToken[]
  organization              Organization?       @relation(fields: [orgId], references: [id])

  @@index([email])
  @@index([emailVerifyToken])
  @@index([passwordResetToken])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  brandingTheme Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  ownerId       String
  events        Event[]
  owner         User     @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       User[]

  @@index([slug])
}

model Event {
  id                 String              @id @default(cuid())
  orgId              String
  name               String
  slug               String              @unique
  startAt            DateTime?
  endAt              DateTime?
  timezone           String?
  visibility         String              @default("public")
  rules              Json?
  features           Json?
  currentRound       Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  description        String?
  archived           Boolean             @default(false)
  brandColors        Json?
  logoUrl            String?
  auditLogs          AuditLog[]
  organization       Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  judges             Judge[]
  judgeInvites       JudgeInvite[]
  participants       Participant[]
  registrationTokens RegistrationToken[]
  roundCompletions   RoundCompletion[]
  scores             Score[]

  @@index([slug])
  @@index([orgId])
  @@index([orgId, slug])
  @@index([visibility])
}

model Participant {
  id               String            @id @default(cuid())
  eventId          String
  kind             ParticipantKind
  name             String
  profile          Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  normalizedName   String
  totalScore       Int               @default(0)
  accessCode       String?
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  roundCompletions RoundCompletion[]
  scores           Score[]
  entries          Submission[]

  @@unique([eventId, normalizedName, kind])
  @@index([eventId])
  @@index([eventId, totalScore])
}

model Score {
  id             String      @id @default(cuid())
  eventId        String
  participantId  String
  value          Int         @default(0)
  criterion      String      @default("unknown")
  judgeUserId    String?
  idempotencyKey String?
  createdAt      DateTime    @default(now())
  comment        String?
  updatedAt      DateTime    @updatedAt
  event          Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant    Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([participantId])
  @@index([eventId, participantId])
  @@index([eventId, criterion])
  @@index([eventId, judgeUserId])
}

model Judge {
  id         String    @id @default(cuid())
  eventId    String
  name       String?
  email      String?
  code       String?   @unique
  role       String    @default("judge")
  active     Boolean   @default(true)
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  hashedCode String?
  event      Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model JudgeInvite {
  id          String    @id @default(cuid())
  token       String    @unique
  eventId     String
  createdById String
  usedById    String?
  usedAt      DateTime?
  expiresAt   DateTime?
  singleUse   Boolean   @default(true)
  metadata    Json?
  createdAt   DateTime  @default(now())
  createdBy   User      @relation("JudgeInviteCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  usedBy      User?     @relation("JudgeInviteUsedBy", fields: [usedById], references: [id])

  @@index([eventId])
  @@index([token])
}

model RegistrationToken {
  id                 String    @id @default(cuid())
  token              String    @unique
  eventId            String
  createdById        String
  usesLeft           Int?
  singleUse          Boolean   @default(false)
  expiresAt          DateTime?
  metadata           Json?
  public             Boolean   @default(false)
  scanCount          Int       @default(0)
  registrationsCount Int       @default(0)
  createdAt          DateTime  @default(now())
  createdBy          User      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  event              Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([token])
}

model RoundCompletion {
  id              String      @id @default(cuid())
  eventId         String
  participantId   String
  roundNumber     Int
  judgeUserId     String?
  completedAt     DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  durationSeconds Int?
  event           Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant     Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([eventId, participantId, roundNumber])
  @@index([eventId, roundNumber])
  @@index([eventId, participantId, roundNumber])
  @@index([eventId, completedAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  eventId    String?
  userId     String
  action     String
  entityType String?
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  event      Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([eventId, createdAt])
}

model Submission {
  id            String      @id @default(cuid())
  participantId String
  roundNumber   Int
  url           String
  notes         String?
  createdAt     DateTime    @default(now())
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([participantId, roundNumber])
}

enum ParticipantKind {
  team
  individual
}
